{% load capture_tags %}
{% load typefixes %}
{% load wagtailcore_tags %}

<article class="blog-post{% if post.content_type.model == 'legacypost' %} legacy{% endif %}{% if post.specific.is_micro %} micro{% endif %}{% if post.specific.is_snapshot %} snapshot{% endif %}{% if page.content_type.model == 'blogindex' %} on-index{% endif %}">

    {% include "mnmnwag/blog_post_header.html" %}

    <div>
        {% with post.specific.body as body %}
            {% if page.content_type.model == 'blogindex' %}

                {# TRUNCATED POST (FOR BLOG INDEX) #}
                {% if post.content_type.model == 'legacypost' %}
                    {{ body|richtext|typefixes|truncatewords_html:150 }}
                    {% ifnotequal body|richtext|typefixes|truncatewords_html:150|length body|richtext|typefixes|truncatewords_html:151|length %}
                        <a class="read-more" href="{% pageurl post %}" up-content-link>read full post &raquo;</a>
                    {% endifnotequal %}
                {% elif post.content_type.model == 'modernpost' %}
					{# if 1st block is teaser, display that + 'read more' #}
					{% if body.0.block_type == 'teaser' %}
						{% with body.0 as block %}
							{% include "mnmnwag/blog_post_block.html" %}
						{% endwith %}
						<a class="read-more" href="{% pageurl post %}" up-content-link>read full post &raquo;</a>
					{# if 1st block is image, 2nd block is teaser, display those + 'read more' #}
					{% elif body.0.block_type == 'image' and body.1.block_type == 'teaser' %}
						{% with body.0 as block %}
							{% include "mnmnwag/blog_post_block.html" %}
						{% endwith %}
						{% with body.1 as block %}
							{% include "mnmnwag/blog_post_block.html" %}
						{% endwith %}
						<a class="read-more" href="{% pageurl post %}" up-content-link>read full post &raquo;</a>
					{# else truncate at 160 chars, display 'read more' if needed #}
					{% else %}
						{% capture as content silent %}
							{% for block in body %}
								{% include "mnmnwag/blog_post_block.html" %}
							{% endfor %}
						{% endcapture %}
						{{ content|typefixes|truncatewords_html:160 }}
						{% ifnotequal content|truncatewords_html:160 content|truncatewords_html:161 %}
							<a class="read-more" href="{% pageurl post %}" up-content-link>read full post &raquo;</a>
						{% endifnotequal %}
					{% endif %}
                {% endif %}

            {% else %}

                {# FULL POST #}
                {% if post.content_type.model == 'legacypost' %}
                    {{ body|richtext|typefixes }}
                {% elif post.content_type.model == 'modernpost' %}
                    {% for block in body %}
                        <div class="block-{{ block.block_type }}">
							{# using capture here b/c we cannot directly apply typefixes to include_block #}
                            {% capture as content silent %}
								{# add page_id and block_id to block context (req'd by ImageBlock and SlidesBlock) #}
                                {% include_block block with page_id=post.id block_id=block.id|slice:'0:7' %}
                            {% endcapture %}
                            {{ content|typefixes }}
                        </div>
                    {% endfor %}
                {% endif %}

            {% endif %}
        {% endwith %}
    </div>

    {% include "mnmnwag/blog_post_footer.html" %}

</article>
